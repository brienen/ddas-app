<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Extern JSON Schema Form met Definitions en Constraints</title>
    <!-- Bootstrap CSS toevoegen -->
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet">
</head>
<body>
    <div class="container my-5">
        <h1 class="mb-4">Extern JSON Schema Form met Definitions en Constraints</h1>
        <!-- Formulier container met Bootstrap-klasse -->
        <form id="jsonForm" class="needs-validation" novalidate></form>
        <button class="btn btn-primary mt-3" onclick="submitForm()">Submit</button>
        <pre id="output" class="mt-4"></pre>
    </div>

    <script>
        // Externe JSON-schema URL
        const schemaUrl = 'https://raw.githubusercontent.com/VNG-Realisatie/ddas/main/v1.0/json_schema_Uitwisselmodel.json'; // Vervang met de URL van je externe JSON-schema

        // Functie om een definitie te dereferenceren en constraints op te halen
        function resolveRef(ref, schema) {
            const path = ref.replace("#/", "").split("/");
            let resolved = schema;
            path.forEach(part => {
                resolved = resolved[part];
            });
            return resolved;
        }

        // Formulier genereren op basis van JSON-schema met constraints
        function generateForm(schema) {
            const form = document.getElementById("jsonForm");

            Object.keys(schema.properties).forEach(key => {
                let property = schema.properties[key];

                // Controleer of de property een $ref heeft en los deze op
                if (property.$ref) {
                    const resolvedProperty = resolveRef(property.$ref, schema);
                    property = { ...resolvedProperty, ...property }; // Combineer de gerefereerde definitie met eventuele extra constraints
                }

                // Bootstrap form group maken
                const formGroup = document.createElement("div");
                formGroup.className = "form-group";

                const label = document.createElement("label");
                label.textContent = property.title || key;
                label.setAttribute("for", key);
                formGroup.appendChild(label);

                const input = document.createElement("input");
                input.type = property.type === "integer" ? "number" : "text";
                input.className = "form-control";
                input.id = key;
                input.name = key;
                input.required = schema.required && schema.required.includes(key);

                // Standaardwaarde instellen (indien aanwezig)
                if (property.default) {
                    input.value = property.default;
                }

                // Placeholder instellen (indien aanwezig)
                if (property.description) {
                    input.placeholder = property.description;
                }

                // Minimale en maximale waarden voor numerieke velden instellen
                if (property.type === "integer" || property.type === "number") {
                    if (property.minimum !== undefined) {
                        input.min = property.minimum;
                    }
                    if (property.maximum !== undefined) {
                        input.max = property.maximum;
                    }
                }

                // Patroon (bijvoorbeeld voor regex-validatie) instellen
                if (property.pattern) {
                    input.pattern = property.pattern;
                }

                // Maximale lengte voor tekstvelden instellen
                if (property.maxLength !== undefined) {
                    input.maxLength = property.maxLength;
                }

                // Minimale lengte voor tekstvelden instellen
                if (property.minLength !== undefined) {
                    input.minLength = property.minLength;
                }

                formGroup.appendChild(input);
                form.appendChild(formGroup);
            });
        }

        // Ophalen van het externe JSON-schema en formulier genereren
        async function loadSchemaAndGenerateForm() {
            try {
                const response = await fetch(schemaUrl);
                if (!response.ok) {
                    throw new Error(`Error: ${response.status} ${response.statusText}`);
                }
                const schema = await response.json();
                generateForm(schema);
            } catch (error) {
                document.getElementById("output").innerHTML = `<div class="alert alert-danger">Kon het JSON-schema niet laden: ${error.message}</div>`;
            }
        }

        // Validatie en gegevensverwerking
        function submitForm() {
            const formData = {};
            const errors = [];
            const form = document.getElementById("jsonForm");

            for (const element of form.elements) {
                if (element.tagName === "INPUT") {
                    const value = element.value.trim();
                    const { name, type, required } = element;
                    if (required && !value) {
                        errors.push(`${name} is vereist`);
                    }
                    if (type === "number" && isNaN(Number(value))) {
                        errors.push(`${name} moet een getal zijn`);
                    }
                    formData[name] = value;
                }
            }

            // Weergeven van resultaten of fouten
            const output = document.getElementById("output");
            if (errors.length > 0) {
                output.innerHTML = `<div class="alert alert-danger">Fouten:<br>${errors.join("<br>")}</div>`;
            } else {
                output.innerHTML = `<div class="alert alert-success">Ingevoerde gegevens:<pre>${JSON.stringify(formData, null, 2)}</pre></div>`;
            }
        }

        // Formulier laden bij het laden van de pagina
        document.addEventListener("DOMContentLoaded", loadSchemaAndGenerateForm);
    </script>
</body>
</html>